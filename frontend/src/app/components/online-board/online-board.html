@if (isSpectator) {
  <div class="alert alert-info text-center">
    <i class="bi bi-eye me-2"></i>
    <strong i18n="@@SPECTATOR.VIEWING_MODE">Spectator Mode</strong>
    <span i18n="@@SPECTATOR.DEFAULT_MESSAGE" class="ms-2">
      You are viewing this game as a spectator. You cannot make moves or chat.
    </span>
  </div>
}

@if (connectionStatus !== 'connected' || showConnectionStatus) {
  <div
    class="connection-status-bar"
    [ngClass]="connectionStatus"
  >
    <div class="container">
      <div class="d-flex align-items-center justify-content-between">
        <div class="connection-info">
          <i class="bi" [ngClass]="{
            'bi-wifi': connectionStatus === 'connected',
            'bi-wifi-off': connectionStatus === 'disconnected', 
            'bi-arrow-clockwise': connectionStatus === 'connecting'
          }"></i>
          <span class="ms-2">
            @if (connectionStatus === 'connected')    { <span i18n="@@WEBSOCKET.CONNECTED">ðŸŸ¢ Connected</span>       }
            @if (connectionStatus === 'connecting')   { <span i18n="@@WEBSOCKET.CONNECTING">ðŸŸ¡ Connecting...</span>  }
            @if (connectionStatus === 'disconnected') { <span i18n="@@WEBSOCKET.DISCONNECTED">ðŸ”´ Disconnected</span> }
          </span>
        </div>
        
        @if (connectionStatus === 'disconnected') {
          <button
            i18n="@@WEBSOCKET.RECONNECT"
            class="btn btn-sm btn-outline-light"
            (click)="refreshConnection()"
          >
            <i class="bi bi-arrow-clockwise me-1"></i>
            Reconnect
          </button>
        }
      </div>
    </div>
  </div>
}

@if (showConnectionError) {
  <div class="alert alert-warning alert-dismissible fade show mx-3 mt-2" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    {{ connectionErrorMessage }}
    <button type="button" class="btn-close" (click)="showConnectionError = false"></button>
  </div>
}

<div class="container">
  <div class="centered-content">
    @if (gameID && needsOpponent() && !isSpectator && userRole === 'PLAYER') { <!-- Show share link card -->
      <div class="card share-card border-info mb-3">
        <div i18n="@@COMMON.SHARE_GAME" class="card-header bg-info text-white">
          <i class="bi bi-share-fill me-2"></i>
          Share this game
        </div>
        <div class="card-body">
          <p i18n="@@COMMON.SHARE_LINK" class="card-text">
            Share this link with your opponent:
          </p>

          <div class="input-group mb-2">
            <input
              #gameLink
              type="text"
              class="form-control"
              [value]="origin + '/join/' + gameID"
              readonly
            >
            <button
              i18n="@@COMMON.COPY"
              class="btn btn-outline-primary"
              type="button"
              (click)="copyToClipboard(gameLink)"
              i18n-title="@@COMMON.COPY"
            >
              <i class="bi bi-clipboard"></i>
              Copy
            </button>
          </div>

          @if (linkCopied) {
            <div
              i18n="@@COMMON.COPY_SUCCESS"
              class="alert alert-success py-1 mt-2 small fade-out"
            >Link copied to clipboard!</div>
          }
        </div>
      </div>
    }

    @if (spectatorCount > 0) { <!-- Show spectator counter -->
      <div class="spectator-counter mt-3">
        <div class="spectator-info">
          <i class="bi bi-eye me-2"></i>
          <span class="spectator-text">
            {{ spectatorCount }} <span i18n="@@SPECTATOR.WATCHING">spectators watching</span>
          </span>
        </div>
      </div>
    }
  </div>

  <div class="main-game-content">
    <div class="board-container" [attr.data-player-team]="playerTeam">
      
      @if (playerTeam !== 'BLACK') { <!-- Different view based on player's team -->

        <!-- Player black on top (opponent) when you are player white or a spectator -->
        <div class="player-info black-player mb-3">
          <div class="player-piece black"></div>
          <div class="player-text">
            <h3>{{ blackPlayerNickname }}</h3>
            <div class="piece-count">
              <span i18n="@@GAME.PIECES">Pieces</span>: {{ blackCount }}
            </div>
          </div>
          <div class="player-stats">
            <span class="status-badge" [ngClass]="currentPlayer === 'black' ? 'status-active' : 'status-waiting'">
              @if (currentPlayer === 'black') { <span i18n="@@GAME.TURN">Turn</span>              }
              @else                           { <span i18n="@@GAME.WAITING_STATUS">Waiting</span> }
            </span>
          </div>
        </div>

        <div class="board-with-coordinates">
          <!-- Letter coordinates (columns) -->
          <div class="column-labels">
            @for (col of columns; track col) {
              <div class="col-label">{{ col }}</div>
            }
          </div>

          <div class="board-with-row-labels">
            <!-- Coordinate numbers (rows) -->
            <div class="row-labels">
              @for (row of rows; track row) {
                <div class="row-label">{{ row }}</div>
              }
            </div>

            <div class="board">
              @for (row of board; track $index; let r = $index) {
                <div class="row">
                  @for (cell of row; track $index; let c = $index) {
                    <div class="square"
                         [ngClass]="{
                           'light': isLight(r, c),
                           'dark': !isLight(r, c),
                           'highlight': isHighlight(r, c),
                           'selected': isSelected(r, c),
                           'has-moves': hasAvailableMoves(r, c),
                           'no-moves': hasNoAvailableMoves(r, c),
                         }"
                         (click)="onCellClick(r, c)"
                    >
                      @if (cell.hasPiece) {
                        <div class="piece"
                            [ngClass]="[cell.pieceColor || '', cell.isKing ? 'king' : '']"
                        >
                          @if (cell.isKing) { <div class="crown">â™›</div> }
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Player white at the bottom (you) when you are player white or a spectator -->
        <div class="player-info white-player mt-3">
          <div class="player-piece white"></div>
          <div class="player-text">
            <h3>{{ whitePlayerNickname }}</h3>
            <div class="piece-count">
              <span i18n="@@GAME.PIECES">Pieces</span>: {{ whiteCount }}
            </div>
          </div>
          <div class="player-stats">
            <span class="status-badge" [ngClass]="currentPlayer === 'white' ? 'status-active' : 'status-waiting'">
              @if (currentPlayer === 'white') { <span i18n="@@GAME.TURN">Turn</span>              }
              @else                           { <span i18n="@@GAME.WAITING_STATUS">Waiting</span> }
            </span>
          </div>
        </div>
      }

      @if (playerTeam === 'BLACK') { <!-- Player white up (opponent) when you are player black -->
        <div class="player-info white-player mb-3">
          <div class="player-piece white"></div>
          <div class="player-text">
            <h3>{{ whitePlayerNickname }}</h3>
            <div class="piece-count">
              <span i18n="@@GAME.PIECES">Pieces</span>: {{ whiteCount }}
            </div>
          </div>
          <div class="player-stats">
            <span class="status-badge" [ngClass]="currentPlayer === 'white' ? 'status-active' : 'status-waiting'">
              @if (currentPlayer === 'white') { <span i18n="@@GAME.TURN">Turn</span>              }
              @else                           { <span i18n="@@GAME.WAITING_STATUS">Waiting</span> }
            </span>
          </div>
        </div>

        <div class="board-with-coordinates">
          <!-- Letter (column) coordinates at the top -->
          <div class="column-labels">
            @for (col of columns; track col) {
              <div class="col-label">{{ col }}</div>
            }
          </div>

          <div class="board-with-row-labels">
            <!-- Coordinate numbers (rows) -->
            <div class="row-labels">
              @for (row of rows; track row) {
                <div class="row-label">{{ row }}</div>
              }
            </div>

            <div class="board">
              @for (row of board; track $index; let r = $index) {
                <div class="row">
                  @for (cell of row; track $index; let c = $index) {
                    <div class="square"
                         [ngClass]="{
                           'light': isLight(r, c),
                           'dark': !isLight(r, c),
                           'highlight': isHighlight(r, c),
                           'selected': isSelected(r, c),
                           'has-moves': hasAvailableMoves(r, c),
                           'no-moves': hasNoAvailableMoves(r, c),
                           'droppable': isHighlight(r, c)
                         }"
                         (click)="onCellClick(r, c)"
                    >
                      @if (cell.hasPiece) {
                        <div class="piece"
                            [ngClass]="[cell.pieceColor || '', cell.isKing ? 'king' : '']"
                        >
                          @if (cell.isKing) { <div class="crown">â™›</div> }
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Player black below (you) when you are player black -->
        <div class="player-info black-player mt-3">
          <div class="player-piece black"></div>
          <div class="player-text">
            <h3>{{ blackPlayerNickname }}</h3>
            <div class="piece-count">
              <span i18n="@@GAME.PIECES">Pieces</span>: {{ blackCount }}
            </div>
          </div>
          <div class="player-stats">
            <span class="status-badge" [ngClass]="currentPlayer === 'black' ? 'status-active' : 'status-waiting'">
              @if (currentPlayer === 'black') { <span i18n="@@GAME.TURN">Turn</span>              }
              @else                           { <span i18n="@@GAME.WAITING_STATUS">Waiting</span> }
            </span>
          </div>
        </div>
      }

      <!-- Turn Information -->
      <div class="status-info mt-3">
        @if (!isSpectator && !playerTeam) {
          <div class="turn-status turn-loading">
            <div class="turn-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12"    y1="2"     x2="12"    y2="6"></line>
                <line x1="12"    y1="18"    x2="12"    y2="22"></line>
                <line x1="4.93"  y1="4.93"  x2="7.76"  y2="7.76"></line>
                <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                <line x1="2"     y1="12"    x2="6"     y2="12"></line>
                <line x1="18"    y1="12"    x2="22"    y2="12"></line>
                <line x1="4.93"  y1="19.07" x2="7.76"  y2="16.24"></line>
                <line x1="16.24" y1="7.76"  x2="19.07" y2="4.93"></line>
              </svg>
            </div>
            <div class="turn-text">
              <h4 i18n="@@GAME.CONNECTING">Connecting</h4>
              <p i18n="@@GAME.ROLE_DETERMINING">Determining role in the game...</p>
            </div>
          </div>
        }
        @else if (needsOpponent()) {  <!-- Show only for players who haven't determined their role yet (not spectators) -->
          <div class="turn-status turn-waiting">
            <div class="turn-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="10" y1="15" x2="10" y2="9"></line>
                <line x1="14" y1="15" x2="14" y2="9"></line>
              </svg>
            </div>
            <div class="turn-text">
              <h4 i18n="@@GAME.WAITING">Waiting...</h4>
              <p i18n="@@JOIN.WAITING_FOR_OPPONENT">The game will start when another player joins.</p>
            </div>
          </div>
        }

        <!-- Only show this section if user is not a spectator -->
        @if (isSpectator && playerTeam) {
          <div class="turn-status-card">
            @if (!needsOpponent() && isPlayerTurn()) {
              <div class="turn-status turn-active">
                <div class="turn-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                  </svg>
                </div>
                <div class="turn-text">
                  <h4 i18n="@@GAME.YOUR_TURN">It's your turn!</h4>
                  <p i18n="@@GAME.MOVE_PIECE">Move a piece to continue.</p>
                </div>
              </div>

              <div class="turn-status turn-waiting">
                <div class="turn-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="10" y1="15" x2="10" y2="9"></line>
                    <line x1="14" y1="15" x2="14" y2="9"></line>
                  </svg>
                </div>
                <div class="turn-text">
                  <h4 i18n="@@GAME.WAITING">Waiting...</h4>
                    @if (currentPlayer === 'white') { <p i18n="@@GAME.WHITE_PLAYER_TURN">White player's turn</p> }
                    @if (currentPlayer === 'black') { <p i18n="@@GAME.BLACK_PLAYER_TURN">Black player's turn</p> }
                </div>
              </div>
            }
          </div>
        }

        @if (isSpectator && !needsOpponent()) { <!-- Show current turn info for spectators -->
          <div class="turn-status turn-waiting">
            <div class="turn-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
            </div>
            <div class="turn-text">
              <h4 i18n="@@GAME.CURRENT_TURN">Current Turn</h4>
              <p>{{ currentPlayer === 'white' ? whitePlayerNickname : blackPlayerNickname }}</p>
            </div>
          </div>
        }
      </div>

      @if (showGameOverModal) { <!-- Game over modal -->
        <div class="game-over-modal">
          <div class="modal-content">
            <div class="close-button" (click)="hideGameOverModal()">âœ•</div>
            <h2 i18n="@@GAME_OVER.TITLE">Game Over!</h2>
            <p>
              <span i18n="@@GAME_OVER.WINNER">The winner is </span> 
              <span class="winner-text">
                @if (winner === 'white') { <span i18n="@@GAME_OVER.WHITE">White</span> }
                @if (winner === 'black') { <span i18n="@@GAME_OVER.BLACK">Black</span> }
              </span>
            </p>

            <!-- Restart status -->
            @if (restartStatus) {
              <div class="restart-status mt-3 mb-3">
                <div class="d-flex justify-content-center gap-3">
                  <!-- Player white status -->
                  <div class="player-restart-status white-player">
                    <span class="player-name">{{ restartStatus.nicknameW }}</span>
                    <span class="restart-icon" [ngClass]="{'ready': restartStatus.restartW}">
                      {{ restartStatus.restartW ? 'âœ“' : 'â—‹' }}
                    </span>
                  </div>

                  <!-- Player black status -->
                  <div class="player-restart-status black-player">
                    <span class="player-name">{{ restartStatus.nicknameB }}</span>
                    <span class="restart-icon" [ngClass]="{'ready': restartStatus.restartB}">
                      {{ restartStatus.restartB ? 'âœ“' : 'â—‹' }}
                    </span>
                  </div>
                </div>
              </div>
            }

            <!-- Status Messages -->
            @if (showRestartRequestedMessage) {
              <div
                i18n="@@GAME_OVER.RESTART_REQUESTED"
                class="alert alert-success mt-2"
              >Rematch request sent!</div>
            }
            @if (waitingForOpponentRestart && !hasOpponentRequestedRestart()) {
              <div
                i18n="@@GAME_OVER.WAITING_FOR_OPPONENT_RESTART"
                class="alert alert-info mt-2"
              >Waiting for opponent to accept rematch...</div>
            }
            @if (hasOpponentRequestedRestart() && !waitingForOpponentRestart) {
              <div
                i18n="@@GAME_OVER.OPPONENT_WANTS_RESTART"
                class="alert alert-info mt-2"
              >Opponent has requested a rematch!</div>
            }

            <!-- Action Buttons -->
            <div class="d-flex justify-content-center gap-3 mt-3">
              
               @if (!waitingForOpponentRestart && gameID) { <!-- Request Rematch Button -->
                <button
                  i18n="@@GAME_OVER.REQUEST_REMATCH"
                  class="btn btn-success"
                  (click)="requestRestart()"
                >Request Rematch</button>
              }

              @if (waitingForOpponentRestart && gameID) { <!-- Cancel Request Button -->
                <button
                  i18n="@@GAME_OVER.CANCEL_REQUEST"
                  class="btn btn-warning"
                  (click)="cancelRestartRequest()"
                >Cancel Request</button>
              }

              <!-- Back to Menu Button -->
              <button
                i18n="@@GAME_OVER.BACK_TO_MENU"
                class="btn btn-secondary"
                (click)="router.navigate(['/play'])"
              >Back to Menu</button>
            </div>
          </div>
        </div>
        <div class="game-over-modal-overlay"></div>
      }
    </div>

    <div class="side-panel">
      <app-online-moves
        [moves]="moves">
      </app-online-moves>

      <app-chat 
        [gameId]="gameID"
        [chatHistory]="chatHistory"
        [nickname]="nickname"
        [isSpectator]="isSpectator"
        [whitePlayerNickname]="whitePlayerNickname"
        [blackPlayerNickname]="blackPlayerNickname">
      </app-chat>
    </div>
  </div>
</div>